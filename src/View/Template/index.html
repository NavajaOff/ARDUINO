<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Sistema de Peaje con Blockchain</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .bg-blockchain {
            background-color: #1a237e;
            color: white;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            border-radius: 10px 10px 0 0;
            font-weight: 600;
        }
        .stat-icon {
            font-size: 2rem;
            margin-right: 15px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .stat-title {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        .hash-text {
            font-family: monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            display: inline-block;
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-blockchain">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-link me-2"></i>
                Sistema de Peaje con Blockchain
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="verificarIntegridad">
                            <i class="fas fa-shield-alt me-1"></i>
                            Verificar Integridad
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link" id="reloj"></span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Status Alert -->
        <div id="statusAlert" class="alert d-none mb-4" role="alert"></div>

        <!-- Stats Cards -->
        <div class="row">
            <!-- Total Registros -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon text-primary">
                            <i class="fas fa-car"></i>
                        </div>
                        <div>
                            <h5 class="stat-value" id="totalRegistros">--</h5>
                            <div class="stat-title">Total Registros</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Total Bloques -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon text-success">
                            <i class="fas fa-cubes"></i>
                        </div>
                        <div>
                            <h5 class="stat-value" id="totalBloques">--</h5>
                            <div class="stat-title">Total Bloques</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Registros 24h -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon text-warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <h5 class="stat-value" id="registros24h">--</h5>
                            <div class="stat-title">Registros últimas 24h</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Integridad -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body d-flex align-items-center">
                        <div class="stat-icon text-info">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div>
                            <h5 class="stat-value" id="integridadStatus">--</h5>
                            <div class="stat-title">Estado Integridad</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Último Registro -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-blockchain">
                        <i class="fas fa-info-circle me-2"></i>
                        Último Registro
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>ID:</strong> <span id="ultimoRegistroId">--</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Fecha/Hora:</strong> <span id="ultimoRegistroFecha">--</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Hash:</strong> <span id="ultimoRegistroHash" class="hash-text">--</span>
                                <button class="btn btn-sm btn-outline-secondary ms-2" id="copyLastHash">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Traffic Chart -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-blockchain">
                        <i class="fas fa-chart-line me-2"></i>
                        Tráfico por Hora (Últimas 24h)
                    </div>
                    <div class="card-body">
                        <canvas id="trafficChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <!-- Daily Stats -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-blockchain">
                        <i class="fas fa-calendar-day me-2"></i>
                        Estadísticas Diarias
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Registros</th>
                                    </tr>
                                </thead>
                                <tbody id="estadisticasDiarias">
                                    <tr>
                                        <td colspan="2" class="text-center">Cargando datos...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blocks Table -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-blockchain">
                        <i class="fas fa-cubes me-2"></i>
                        Últimos Bloques
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Índice</th>
                                        <th>Timestamp</th>
                                        <th>Hash</th>
                                        <th>Hash Anterior</th>
                                        <th>Nonce</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="bloquesTable">
                                    <tr>
                                        <td colspan="6" class="text-center">Cargando bloques...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <nav aria-label="Navegación de bloques">
                            <ul class="pagination justify-content-center mb-0" id="bloquesPagination">
                                <!-- Pagination items will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Block Detail Modal -->
    <div class="modal fade" id="blockDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-blockchain">
                    <h5 class="modal-title">
                        <i class="fas fa-cube me-2"></i>
                        Detalles del Bloque #<span id="modalBlockIndex"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3" id="modalBlockStatus"></div>
                    
                    <h6 class="border-bottom pb-2 mb-3">Información del Bloque</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Hash:</strong>
                            <div class="text-break">
                                <code id="modalBlockHash"></code>
                                <button class="btn btn-sm btn-outline-secondary ms-2" id="copyBlockHash">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <strong>Hash Anterior:</strong>
                            <div class="text-break">
                                <code id="modalBlockPrevHash"></code>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Fecha/Hora:</strong>
                            <div id="modalBlockTime"></div>
                        </div>
                        <div class="col-md-6">
                            <strong>Nonce:</strong>
                            <div id="modalBlockNonce"></div>
                        </div>
                    </div>
                    
                    <h6 class="border-bottom pb-2 mb-3">Datos</h6>
                    <pre id="modalBlockData" class="bg-light p-3 rounded"></pre>
                    
                    <h6 class="border-bottom pb-2 mb-3">Registros Asociados</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="modalBlockRegistros">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha/Hora</th>
                                    <th>Hash</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Registros se agregarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- App JS -->
    <script>
        // Variables globales
        let trafficChart;
        let currentBlockPage = 1;
        
        // Mostrar fecha y hora actuales
        function updateClock() {
            const now = new Date();
            document.getElementById('reloj').textContent = now.toLocaleString();
        }
        
        // Cargar estadísticas generales
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                // Actualizar estadísticas
                document.getElementById('totalRegistros').textContent = data.total_registros;
                document.getElementById('totalBloques').textContent = data.total_bloques;
                document.getElementById('registros24h').textContent = data.registros_24h;
                
                // Mostrar estado de integridad
                const integridadStatus = document.getElementById('integridadStatus');
                if (data.integridad) {
                    integridadStatus.textContent = 'Verificada';
                    integridadStatus.classList.add('text-success');
                } else {
                    integridadStatus.textContent = 'Comprometida';
                    integridadStatus.classList.add('text-danger');
                }
                
                // Actualizar último registro
                if (data.ultimo_registro) {
                    document.getElementById('ultimoRegistroId').textContent = data.ultimo_registro.id;
                    document.getElementById('ultimoRegistroFecha').textContent = new Date(data.ultimo_registro.fecha_hora).toLocaleString();
                    document.getElementById('ultimoRegistroHash').textContent = data.ultimo_registro.hash_bloque;
                }
            } catch (error) {
                console.error('Error al cargar estadísticas:', error);
                showAlert('Error al cargar estadísticas. Intente nuevamente.', 'danger');
            }
        }
        
        // Cargar datos de tráfico por hora
        async function loadTrafficData() {
            try {
                const response = await fetch('/api/trafico_por_hora');
                const data = await response.json();
                
                // Preparar datos para gráfico
                const labels = data.map(item => `${item.hora}:00`);
                const values = data.map(item => item.cantidad);
                
                // Crear gráfico
                const ctx = document.getElementById('trafficChart').getContext('2d');
                if (trafficChart) {
                    trafficChart.destroy();
                }
                
                trafficChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Vehículos',
                            data: values,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al cargar datos de tráfico:', error);
                showAlert('Error al cargar datos de tráfico. Intente nuevamente.', 'danger');
            }
        }
        
        // Cargar estadísticas diarias
        async function loadDailyStats() {
            try {
                const response = await fetch('/api/estadisticas_diarias');
                const data = await response.json();
                
                const tbody = document.getElementById('estadisticasDiarias');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="2" class="text-center">No hay datos disponibles</td>';
                    tbody.appendChild(row);
                    return;
                }
                
                // Crear filas con datos
                data.forEach(item => {
                    const row = document.createElement('tr');
                    const date = new Date(item.fecha).toLocaleDateString();
                    
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${item.cantidad}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error al cargar estadísticas diarias:', error);
                showAlert('Error al cargar estadísticas diarias. Intente nuevamente.', 'danger');
            }
        }
        
        // Cargar bloques con paginación
        async function loadBlocks(page = 1) {
            try {
                currentBlockPage = page;
                const response = await fetch(`/api/bloques?page=${page}&limit=10`);
                const data = await response.json();
                
                const tbody = document.getElementById('bloquesTable');
                tbody.innerHTML = '';
                
                if (data.bloques.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="6" class="text-center">No hay bloques disponibles</td>';
                    tbody.appendChild(row);
                    return;
                }
                
                // Crear filas con datos de bloques
                data.bloques.forEach(bloque => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${bloque.indice}</td>
                        <td>${bloque.fecha}</td>
                        <td><span class="hash-text">${bloque.hash}</span></td>
                        <td><span class="hash-text">${bloque.hash_anterior}</span></td>
                        <td>${bloque.nonce}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-block" data-indice="${bloque.indice}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Configurar paginación
                setupPagination(data.page, data.pages);
                
                // Asignar eventos a botones de ver detalles
                document.querySelectorAll('.view-block').forEach(button => {
                    button.addEventListener('click', () => {
                        const indice = button.getAttribute('data-indice');
                        showBlockDetails(indice);
                    });
                });
            } catch (error) {
                console.error('Error al cargar bloques:', error);
                showAlert('Error al cargar bloques. Intente nuevamente.', 'danger');
            }
        }
        
        // Configurar paginación
        function setupPagination(currentPage, totalPages) {
            const pagination = document.getElementById('bloquesPagination');
            pagination.innerHTML = '';
            
            // Botón anterior
            const prevItem = document.createElement('li');
            prevItem.classList.add('page-item');
            if (currentPage === 1) prevItem.classList.add('disabled');
            
            const prevLink = document.createElement('a');
            prevLink.classList.add('page-link');
            prevLink.href = '#';
            prevLink.innerHTML = '&laquo;';
            prevLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) loadBlocks(currentPage - 1);
            });
            
            prevItem.appendChild(prevLink);
            pagination.appendChild(prevItem);
            
            // Páginas
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);
            
            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageItem = document.createElement('li');
                pageItem.classList.add('page-item');
                if (i === currentPage) pageItem.classList.add('active');
                
                const pageLink = document.createElement('a');
                pageLink.classList.add('page-link');
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadBlocks(i);
                });
                
                pageItem.appendChild(pageLink);
                pagination.appendChild(pageItem);
            }
            
            // Botón siguiente
            const nextItem = document.createElement('li');
            nextItem.classList.add('page-item');
            if (currentPage === totalPages) nextItem.classList.add('disabled');
            
            const nextLink = document.createElement('a');
            nextLink.classList.add('page-link');
            nextLink.href = '#';
            nextLink.innerHTML = '&raquo;';
            nextLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) loadBlocks(currentPage + 1);
            });
            
            nextItem.appendChild(nextLink);
            pagination.appendChild(nextItem);
        }
        
        // Mostrar detalles del bloque
        async function showBlockDetails(indice) {
            try {
                const response = await fetch(`/api/bloque/${indice}`);
                const data = await response.json();
                
                const bloque = data.bloque;
                
                // Actualizar campos del modal
                document.getElementById('modalBlockIndex').textContent = bloque.indice;
                document.getElementById('modalBlockHash').textContent = bloque.hash;
                document.getElementById('modalBlockPrevHash').textContent = bloque.hash_anterior;
                document.getElementById('modalBlockTime').textContent = bloque.fecha;
                document.getElementById('modalBlockNonce').textContent = bloque.nonce;
                
                // Mostrar datos en formato JSON
                let datosStr;
                if (typeof bloque.datos === 'object') {
                    datosStr = JSON.stringify(bloque.datos, null, 2);
                } else {
                    datosStr = bloque.datos;
                }
                document.getElementById('modalBlockData').textContent = datosStr;
                
                // Mostrar estado de integridad
                const statusDiv = document.getElementById('modalBlockStatus');
                if (data.es_valido) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Este bloque es válido y mantiene la integridad de la cadena.
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ¡ALERTA! Este bloque no es válido. La integridad de la cadena puede estar comprometida.
                        </div>
                    `;
                }
                
                // Mostrar registros asociados
                const registrosTable = document.getElementById('modalBlockRegistros').querySelector('tbody');
                registrosTable.innerHTML = '';
                
                if (data.registros.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="3" class="text-center">No hay registros asociados a este bloque</td>';
                    registrosTable.appendChild(row);
                } else {
                    data.registros.forEach(registro => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${registro.id}</td>
                            <td>${new Date(registro.fecha_hora).toLocaleString()}</td>
                            <td><span class="hash-text">${registro.hash_bloque}</span></td>
                        `;
                        registrosTable.appendChild(row);
                    });
                }
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('blockDetailModal'));
                modal.show();
                
                // Botón para copiar hash
                document.getElementById('copyBlockHash').addEventListener('click', () => {
                    navigator.clipboard.writeText(bloque.hash)
                        .then(() => {
                            alert('Hash copiado al portapapeles');
                        })
                        .catch(err => {
                            console.error('Error al copiar hash:', err);
                        });
                });
            } catch (error) {
                console.error('Error al cargar detalles del bloque:', error);
                showAlert('Error al cargar detalles del bloque. Intente nuevamente.', 'danger');
            }
        }
        
        // Verificar integridad de la blockchain
        async function checkIntegrity() {
            try {
                const response = await fetch('/api/verificar_integridad');
                const data = await response.json();
                
                // Mostrar mensaje de resultado
                if (data.integridad_ok) {
                    showAlert('Verificación exitosa: La integridad de la blockchain está garantizada.', 'success');
                } else {
                    showAlert('¡ALERTA! Se han detectado problemas de integridad en la blockchain.', 'danger');
                }
            } catch (error) {
                console.error('Error al verificar integridad:', error);
                showAlert('Error al verificar integridad. Intente nuevamente.', 'danger');
            }
        }
        
        // Mostrar alerta
        function showAlert(message, type) {
            const alert = document.getElementById('statusAlert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.classList.remove('d-none');
            
            // Ocultar alerta después de 5 segundos
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 5000);
        }
        
        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', async () => {
            // Configurar reloj
            updateClock();
            setInterval(updateClock, 1000);
            
            try {
                // Cargar datos iniciales
                await Promise.all([
                    loadStats(),
                    loadTrafficData(),
                    loadDailyStats(),
                    loadBlocks()
                ]);
                
                // Ocultar overlay de carga
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Configurar botón para verificar integridad
                document.getElementById('verificarIntegridad').addEventListener('click', (e) => {
                    e.preventDefault();
                    checkIntegrity();
                });
                
                // Botón para copiar hash del último registro
                document.getElementById('copyLastHash').addEventListener('click', () => {
                    const hash = document.getElementById('ultimoRegistroHash').textContent;
                    navigator.clipboard.writeText(hash)
                        .then(() => {
                            alert('Hash copiado al portapapeles');
                        })
                        .catch(err => {
                            console.error('Error al copiar hash:', err);
                        });
                });
                
                // Actualizar datos cada 30 segundos
                setInterval(() => {
                    loadStats();
                    loadTrafficData();
                    loadDailyStats();
                    loadBlocks(currentBlockPage);
                }, 30000);
                
            } catch (error) {
                console.error('Error al inicializar la aplicación:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                showAlert('Error al cargar la aplicación. Intente recargar la página.', 'danger');
            }
        });
    </script>
</body>
</html>